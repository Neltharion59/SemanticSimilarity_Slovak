"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.10.20"
__checksum__ = "e8d660f42fda9fffeeb63d9cd2563b198a26809b079664cd43c369d56aec8108"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 29), (226, 45), (271, 7), (278, 9), (287, 36), (323, 10), (333, 10), (343, 21), None, (364, 50), (414, 8), (422, 18), (440, 19), (459, 13), (472, 14), (486, 14), None, None, (500, 29), (529, 16), (545, 35), (580, 14), (594, 24), (618, 9), None, (627, 25), (652, 20), (672, 8), (680, 13), (693, 10), None, (703, 17), (720, 6), (726, 26), (752, 5), (757, 5), (762, 10), (772, 10), (782, 11), (793, 12), (805, 27), None, (832, 11), (843, 11), (854, 7), (861, 29), (890, 18), (908, 27), (935, 46), (981, 25), (1006, 16), (1022, 8), (1030, 5), (1035, 22), (1057, 18), None, (1075, 36), (1111, 15), (1126, 8), (1134, 11), None, (1145, 5), (1150, 16), (1166, 14), (1180, 18), None, (1198, 14), (1212, 26), (1238, 48), (1286, 19), (1305, 5), (1310, 46), (1356, 14), (1370, 14), (1384, 20), None, (1404, 10), (1414, 13), (1427, 10), (1437, 19), None, (1456, 13), (1469, 19), (1488, 11), (1499, 4), (1503, 22), (1525, 10), (1535, 7), (1542, 14), (1556, 21), (1577, 11), (1588, 10), (1598, 12), (1610, 32), None, (1642, 10), (1652, 14), (1666, 12), (1678, 45), (1723, 15), None, (1738, 11), (1749, 23), (1772, 21), (1793, 26), (1819, 6), (1825, 6), (1831, 7), (1838, 5), (1843, 20), (1863, 23), (1886, 24), (1910, 13), (1923, 15), (1938, 19), (1957, 6), (1963, 61), (2024, 44), (2068, 12), (2080, 23), (2103, 16), (2119, 38), (2157, 6), (2163, 12), (2175, 44), (2219, 6), (2225, 41), (2266, 13), (2279, 23), (2302, 30), (2332, 16), (2348, 8), (2356, 15), (2371, 12), (2383, 19), (2402, 21), (2423, 15), None, (2438, 35), (2473, 21), (2494, 17), (2511, 19), (2530, 26), (2556, 5), (2561, 37), (2598, 26), (2624, 16), (2640, 10), (2650, 17), (2667, 23), (2690, 14), (2704, 17), (2721, 8), (2729, 4), (2733, 7), (2740, 29), (2769, 6), (2775, 18), (2793, 27), (2820, 20), (2840, 17), (2857, 19), (2876, 12), (2888, 40), (2928, 40), (2968, 12), (2980, 48), (3028, 25), (3053, 12), None, (3065, 8), (3073, 20), (3093, 19), (3112, 6), (3118, 23), None, (3141, 30), (3171, 33), (3204, 14), (3218, 12), (3230, 27), None, (3257, 26), (3283, 41), (3324, 50), (3374, 15), (3389, 20), (3409, 15), (3424, 21), (3445, 32), (3477, 24), (3501, 20), (3521, 13), (3534, 60), (3594, 19), (3613, 9), (3622, 12), (3634, 12), (3646, 11), (3657, 10), (3667, 48), (3715, 32), None, (3747, 25), (3772, 12), None, (3784, 8), (3792, 8), (3800, 7), None, (3807, 25), (3832, 17), None, (3849, 21), (3870, 35), (3905, 12), (3917, 10), (3927, 36), (3963, 20), (3983, 22), (4005, 23), (4028, 19), (4047, 12), (4059, 5), (4064, 30), (4094, 24), (4118, 14), (4132, 14), (4146, 47), (4193, 46), None, None, (4239, 51), (4290, 42), None, (4332, 14), None, (4346, 15), (4361, 8), (4369, 21), (4390, 6), (4396, 16), (4412, 17)], [(4429, 6432), (10861, 7000), (17861, 7263), (25124, 6189), (31313, 6547), (37860, 6317), (44177, 7195), (51372, 6412), (57784, 7034), (64818, 6246), (71064, 7371), (78435, 6649), (85084, 6836), (91920, 7440), (99360, 6646), (106006, 6985), (112991, 7208), (120199, 6122), (126321, 6460), (132781, 6745), (139526, 7149), (146675, 6729), (153404, 7130), (160534, 6321), (166855, 6613), (173468, 6817), (180285, 7023), (187308, 7198), (194506, 6398), (200904, 6951), (207855, 7059), (214914, 6638), (221552, 6714), (228266, 7222), (235488, 6318), (241806, 6938), (248744, 6406), (255150, 7237), (262387, 6997), (269384, 7099), (276483, 7676), (284159, 6588), (290747, 6589), (297336, 6338), (303674, 6495), (310169, 6398), (316567, 6582), (323149, 7251), (330400, 6537), (336937, 6158), (343095, 6573), (349668, 6805), (356473, 6810), (363283, 7000), (370283, 7071), (377354, 6996), (384350, 7034), (391384, 6264), (397648, 7113), (404761, 5996), (410757, 6877), (417634, 6590), (424224, 6541), (430765, 7023), (437788, 6783), (444571, 6878), (451449, 6381), (457830, 7307), (465137, 7139), (472276, 6884), (479160, 6691), (485851, 6694), (492545, 5831), (498376, 7094), (505470, 7249), (512719, 7350), (520069, 6183), (526252, 7382), (533634, 7200), (540834, 6256), (547090, 7065), (554155, 5982), (560137, 6712), (566849, 6813), (573662, 6632), (580294, 6584), (586878, 7094), (593972, 6835), (600807, 7054), (607861, 6900), (614761, 7558), (622319, 6136), (628455, 6432), (634887, 6735), (641622, 6699), (648321, 7266), (655587, 7285), (662872, 6536), (669408, 6472), (675880, 6389), (682269, 6459), (688728, 6912), (695640, 6419), (702059, 6684), (708743, 6368), (715111, 6983), (722094, 6995), (729089, 7264), (736353, 8253), (744606, 7383), (751989, 7177), (759166, 6766), (765932, 6538), (772470, 6834), (779304, 7139), (786443, 6911), (793354, 6361), (799715, 6506), (806221, 6548), (812769, 7321), (820090, 7172), (827262, 7187), (834449, 7089), (841538, 7150), (848688, 7953), (856641, 6553), (863194, 5993), (869187, 7122), (876309, 6701), (883010, 8351), (891361, 7379), (898740, 6288), (905028, 6980), (912008, 7007), (919015, 6505), (925520, 7016), (932536, 6271), (938807, 6788), (945595, 6568), (952163, 6806), (958969, 6878), (965847, 7502), (973349, 6422), (979771, 6469), (986240, 6892), (993132, 6726), (999858, 6812), (1006670, 7036), (1013706, 6434), (1020140, 7397), (1027537, 6767), (1034304, 6954), (1041258, 7176), (1048434, 6612), (1055046, 6820), (1061866, 6811), (1068677, 6614), (1075291, 6701), (1081992, 6394), (1088386, 6194), (1094580, 6428), (1101008, 6884), (1107892, 7490), (1115382, 6290), (1121672, 6709), (1128381, 7122), (1135503, 6486), (1141989, 6519), (1148508, 7230), (1155738, 6684), (1162422, 6067), (1168489, 6821), (1175310, 7910), (1183220, 6311), (1189531, 6476), (1196007, 7092), (1203099, 6597), (1209696, 6872), (1216568, 6671), (1223239, 6175), (1229414, 7768), (1237182, 6937), (1244119, 6777), (1250896, 7156), (1258052, 7590), (1265642, 7517), (1273159, 6294), (1279453, 7218), (1286671, 6490), (1293161, 6706), (1299867, 7044), (1306911, 6511), (1313422, 7048), (1320470, 7235), (1327705, 6719), (1334424, 6816), (1341240, 6618), (1347858, 6690), (1354548, 6946), (1361494, 6515), (1368009, 6903), (1374912, 6213), (1381125, 7246), (1388371, 7076), (1395447, 6740), (1402187, 7296), (1409483, 5942), (1415425, 6882), (1422307, 6783), (1429090, 7053), (1436143, 6980), (1443123, 7281), (1450404, 6872), (1457276, 7116), (1464392, 7036), (1471428, 6643), (1478071, 6772), (1484843, 6797), (1491640, 6913), (1498553, 6652), (1505205, 6883), (1512088, 6242), (1518330, 7729), (1526059, 6919), (1532978, 6460), (1539438, 6778), (1546216, 6892), (1553108, 6221), (1559329, 7028), (1566357, 6696), (1573053, 7752), (1580805, 6586), (1587391, 6267), (1593658, 7153), (1600811, 6594), (1607405, 7361), (1614766, 6379), (1621145, 6485), (1627630, 5911), (1633541, 6907), (1640448, 6723), (1647171, 7028), (1654199, 6506), (1660705, 6815), (1667520, 6618), (1674138, 7268), (1681406, 6646), (1688052, 6021), (1694073, 6758), (1700831, 6459), (1707290, 6973), (1714263, 7209), (1721472, 7302), (1728774, 6383), (1735157, 6490), (1741647, 6871)], [(1748518, 742), (1749260, 669), (1749929, 665), (1750594, 768), (1751362, 564), (1751926, 670), (1752596, 698), (1753294, 850), (1754144, 640), (1754784, 667), (1755451, 551), (1756002, 626), (1756628, 792), (1757420, 885), (1758305, 1046), (1759351, 868), (1760219, 1242), (1761461, 684), (1762145, 901), (1763046, 713), (1763759, 757), (1764516, 765), (1765281, 865), (1766146, 731), (1766877, 747), (1767624, 715), (1768339, 955), (1769294, 1146), (1770440, 831), (1771271, 748), (1772019, 922), (1772941, 818), (1773759, 611), (1774370, 733), (1775103, 760), (1775863, 814), (1776677, 691), (1777368, 760), (1778128, 742), (1778870, 1119), (1779989, 695), (1780684, 827), (1781511, 748), (1782259, 719), (1782978, 728), (1783706, 441), (1784147, 942), (1785089, 896), (1785985, 746), (1786731, 592), (1787323, 834), (1788157, 673), (1788830, 780), (1789610, 1012), (1790622, 944), (1791566, 558), (1792124, 681), (1792805, 569), (1793374, 607), (1793981, 771), (1794752, 772), (1795524, 796), (1796320, 1054), (1797374, 956), (1798330, 725), (1799055, 719), (1799774, 767), (1800541, 494), (1801035, 595), (1801630, 592), (1802222, 692), (1802914, 877), (1803791, 636), (1804427, 742), (1805169, 650), (1805819, 685), (1806504, 590), (1807094, 711), (1807805, 808), (1808613, 496), (1809109, 814), (1809923, 629), (1810552, 828), (1811380, 682), (1812062, 619), (1812681, 439), (1813120, 597), (1813717, 746), (1814463, 804), (1815267, 782), (1816049, 883), (1816932, 1092), (1818024, 839), (1818863, 856), (1819719, 725), (1820444, 457), (1820901, 955), (1821856, 857), (1822713, 606), (1823319, 671), (1823990, 728), (1824718, 885), (1825603, 917), (1826520, 571), (1827091, 632), (1827723, 772), (1828495, 471), (1828966, 483), (1829449, 953), (1830402, 963), (1831365, 863), (1832228, 793), (1833021, 652), (1833673, 792), (1834465, 672), (1835137, 699), (1835836, 709), (1836545, 525), (1837070, 722), (1837792, 710), (1838502, 952), (1839454, 721), (1840175, 804), (1840979, 459), (1841438, 691), (1842129, 810), (1842939, 835), (1843774, 926), (1844700, 806), (1845506, 964), (1846470, 802), (1847272, 524), (1847796, 815), (1848611, 672), (1849283, 803), (1850086, 794), (1850880, 737), (1851617, 681), (1852298, 688), (1852986, 673), (1853659, 621), (1854280, 696), (1854976, 711), (1855687, 648), (1856335, 517), (1856852, 603), (1857455, 661), (1858116, 597), (1858713, 729), (1859442, 594), (1860036, 773), (1860809, 537), (1861346, 550), (1861896, 701), (1862597, 642), (1863239, 657), (1863896, 660), (1864556, 884), (1865440, 658), (1866098, 622), (1866720, 941), (1867661, 870), (1868531, 583), (1869114, 695), (1869809, 844), (1870653, 659), (1871312, 692), (1872004, 471), (1872475, 628), (1873103, 694), (1873797, 810), (1874607, 654), (1875261, 932), (1876193, 760), (1876953, 807), (1877760, 721), (1878481, 668), (1879149, 582), (1879731, 704), (1880435, 706), (1881141, 1444), (1882585, 575), (1883160, 662), (1883822, 650), (1884472, 1027), (1885499, 800), (1886299, 798), (1887097, 567), (1887664, 609), (1888273, 846), (1889119, 601), (1889720, 589), (1890309, 814), (1891123, 737), (1891860, 892), (1892752, 810), (1893562, 785), (1894347, 710), (1895057, 868), (1895925, 637), (1896562, 947), (1897509, 662), (1898171, 842), (1899013, 630), (1899643, 742), (1900385, 510), (1900895, 828), (1901723, 843), (1902566, 665), (1903231, 916), (1904147, 777), (1904924, 840), (1905764, 954), (1906718, 1077), (1907795, 887), (1908682, 669), (1909351, 933), (1910284, 731), (1911015, 546), (1911561, 443), (1912004, 794), (1912798, 823), (1913621, 455), (1914076, 1028), (1915104, 513), (1915617, 798), (1916415, 881), (1917296, 792), (1918088, 806), (1918894, 696), (1919590, 826), (1920416, 751), (1921167, 784), (1921951, 585), (1922536, 579), (1923115, 476), (1923591, 666), (1924257, 484), (1924741, 816), (1925557, 894), (1926451, 776), (1927227, 718), (1927945, 658), (1928603, 604), (1929207, 890), (1930097, 495), (1930592, 606), (1931198, 780), (1931978, 510), (1932488, 885), (1933373, 2112), (1935485, 565), (1936050, 705), (1936755, 890), (1937645, 971), (1938616, 539)], [(1939155, 48), None, (1939203, 35), (1939238, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1939280, 42), None, (1939322, 25), (1939347, 44), (1939391, 22), (1939413, 18), None, None, None, None, (1939431, 26), None, None, None, None, (1939457, 21), (1939478, 25), None, None, (1939503, 26), None, None, None, None, (1939529, 44), (1939573, 21), (1939594, 23), None, None, None, None, (1939617, 48), None, None, None, None, None, (1939665, 31), None, None, None, None, (1939696, 42), None, (1939738, 22), None, (1939760, 21), None, (1939781, 26), (1939807, 42), None, None, (1939849, 77), None, None, None, None, None, (1939926, 21), (1939947, 21), None, None, (1939968, 34), (1940002, 42), None, None, None, (1940044, 25), None, None, (1940069, 21), None, None, None, None, None, (1940090, 24), (1940114, 21), None, None, (1940135, 26), None, (1940161, 18), None, (1940179, 54), None, None, None, None, None, None, (1940233, 26), None, (1940259, 19), None, (1940278, 20), None, None, (1940298, 42), (1940340, 42), (1940382, 17), (1940399, 17), (1940416, 26), None, (1940442, 26), None, None, None, (1940468, 26), (1940494, 20), (1940514, 26), None, (1940540, 42), (1940582, 63), None, None, None, (1940645, 40), (1940685, 48), None, None, None, (1940733, 47), None, None, None, None, None, None, None, (1940780, 42), None, (1940822, 55), None, (1940877, 9), None, (1940886, 21), (1940907, 42), None, None, (1940949, 65), (1941014, 82), None, None, (1941096, 42), None, None, None, None, None, None, None, None, None, (1941138, 42), (1941180, 21), (1941201, 21), None, (1941222, 42), (1941264, 25), None, (1941289, 16), (1941305, 21), (1941326, 42), None, None, (1941368, 21), (1941389, 19), (1941408, 26), None, (1941434, 16), None, (1941450, 39), None, None, (1941489, 38), None, (1941527, 22), (1941549, 21), (1941570, 21), None, None, (1941591, 63), None, (1941654, 21), (1941675, 42), None, (1941717, 17), None, None, None, None, (1941734, 21), (1941755, 21), None, None, (1941776, 21), None, None, (1941797, 21), None, (1941818, 26), None, (1941844, 50), None, None, None, (1941894, 50), (1941944, 26), (1941970, 21), (1941991, 21), (1942012, 19), None, (1942031, 35), (1942066, 26), (1942092, 23), (1942115, 21), (1942136, 42), None, None, None, None, None, None, (1942178, 21), None, None, None, (1942199, 21), None, None, (1942220, 90), None, (1942310, 239), (1942549, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
